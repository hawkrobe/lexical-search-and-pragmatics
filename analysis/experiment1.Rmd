---
title: "E1: online candidate generation"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Imports

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggthemes)
library(tidyboot)
library(here)
targets = read_csv(here("data/targets.csv")) %>% select(wordpair, Level)
```

```{r}
softmax_t = function (x, tau){
  e_x = exp(x*tau)
  axis_sum = sum(e_x)
  return (e_x / axis_sum)
}
```

# examine walk scores

```{r}
exp1_scores_plot = read_csv(here("data/exp1/exp1_scores.csv")) %>%
  gather(budget, value, union_2:intersection_512) %>%
  filter(variable %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueOption4')) %>%
  mutate(Level = fct_relevel(Level, 'Easy', 'Medium', 'Hard')) %>%
  group_by(budget, Level, variable) %>%
  tidyboot_mean(value,nboot=100) %>%
  separate(budget, into = c('strategy', 'budget')) %>%
  ggplot(aes(x = as.numeric(budget), y = empirical_stat, color = variable, fill = variable)) +
    geom_line(size=1, position = 'dodge') +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.1, color = NA) +
    facet_grid(strategy ~ Level, scales = 'free') +
    theme_few() +
    scale_color_few() +
    labs(x = 'budget', y = 'visit score')

ggsave("../analysis/plots/exp1_plot1.pdf", exp1_scores_plot)
```

# control 1: examine midpoint scores

```{r}
 read_csv(here("data/exp1/midpoint_scores.csv"))%>% select(-c(1,2)) %>% distinct() %>%
  gather(budget, value,`mid_2`:`mid_512`) %>%
  filter(variable %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueOption4')) %>%
  mutate(Level = fct_relevel(Level, 'Easy', 'Medium', 'Hard')) %>%
  group_by(budget, Level, variable) %>%
  tidyboot_mean(value,nboot=100) %>%
  separate(budget, into = c('strategy', 'budget')) %>%
  ggplot(aes(x = as.numeric(budget), y = empirical_stat, color = variable, fill = variable)) +
    geom_line(size=1, position = 'dodge') +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.1, color = NA) +
    facet_grid(strategy ~ Level, scales = 'free') +
    theme_few() +
    scale_color_few() +
    labs(x = 'budget', y = 'visit score')
```

# control 2: examine frequency scores

```{r}
 read_csv(here("data/exp1/freq_scores.csv"))%>% select(-c(1,2)) %>% distinct() %>%
  gather(budget, value,`freq_2`:`freq_512`) %>%
  filter(variable %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueOption4')) %>%
  mutate(Level = fct_relevel(Level, 'Easy', 'Medium', 'Hard')) %>%
  group_by(budget, Level, variable) %>%
  tidyboot_mean(value,nboot=100) %>%
  separate(budget, into = c('strategy', 'budget')) %>%
  ggplot(aes(x = as.numeric(budget), y = empirical_stat, color = variable, fill = variable)) +
    geom_line(size=1, position = 'dodge') +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.1, color = NA) +
    facet_grid(strategy ~ Level, scales = 'free') +
    theme_few() +
    scale_color_few() +
    labs(x = 'budget', y = 'visit score')
```
### MAY NOT NEED THESE EXTRA ANALYSES ###
# Examine lists of candidates

We compare the candidates generated by the models with the candidates generated by participants in a study.

```{r}
e1 = read_csv(here("data/exp1/e1_common_candidates.csv")) %>%
  mutate(Level = fct_relevel(Level, "easy", "medium","hard"))%>%
      mutate(budget = as.numeric(gsub("[^0-9.-]", "", budget)))
```

## overall common candidates

```{r}
common_candidates= e1 %>% rowwise()%>%
  mutate(prop_common_union = len_union_common/len_cluelist_behavioral,
    prop_common_intersection = len_intersection_common/len_cluelist_behavioral) %>%
  pivot_longer(names_to = "model", cols = prop_common_union:prop_common_intersection)%>%
  separate(model, into = c("prop", "index", "model")) %>% select(-c(prop,index))

e1plot = common_candidates %>% 
  group_by(Level, budget, model) %>%
  summarise(ci = list(mean_cl_boot(value) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% unnest%>%
ggplot(aes(x = budget, y = mean, color = model, group = model)) +
  geom_errorbar(aes(ymin=lwr, ymax=upr), size = 0.5, width=.2, 
                color = "gray", position = position_dodge(0))+
  geom_line()+
  geom_point(size = 2)+
  facet_wrap(~Level)+
    labs(y = 'common candidates (proportion)', 
         title = "proportion of common candidates with behavioral data") +
  scale_color_calc()+
  theme_few() +
  theme(aspect.ratio = 1, legend.position = c(0.85, 0.2)) 

ggsave("../../analysis/plots/exp1_plot1.pdf", e1plot)

```

## final clue

```{r}
e1_finalclue = e1 %>% select(clueGiverID, Level, wordpair, clueFinal, 
                              budget, finalclue_index_union, finalclue_index_intersection) %>%
  pivot_longer(names_to = "model", cols = finalclue_index_union:finalclue_index_intersection) %>%
  separate(model, into = c("finalclue", "index", "model")) %>% select(-c(finalclue,index))%>%
  # set -1 to the lowest visitation frequency and take proportion for others
  # value == 1 means most visited node, value == 0 means not visited at all
  mutate(value = ifelse(value == -1, 0, (12218-value)/12218))

e1plot2 = e1_finalclue %>% 
  group_by(budget, model) %>%
  summarise(ci = list(mean_cl_boot(value) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% unnest%>%
  ggplot(aes(x = budget, y = mean, color = model, group = model)) +
  geom_errorbar(aes(ymin=lwr, ymax=upr), size = 0.5, width=.2, 
                color = "gray", position = position_dodge(0))+
  geom_line()+
  geom_point(size = 2)+
  labs(y = 'mean visitation proportion for final clue', 
       title = "proportion of final clue visitation") +
  theme_few() +
  scale_color_calc()+
  theme(aspect.ratio = 1, 
          legend.position = c(0.85, 0.2)) 
ggsave("../../analysis/plots/exp1_plot2.pdf", e1plot2)
```

