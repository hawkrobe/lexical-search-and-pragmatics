---
title: "Exp. 1: online candidate generation"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Imports

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggthemes)
library(tidyboot)
library(here)
library(jsonlite)
```

# 1. Qualitative results

## Vocab

```{r}
vocab <- read_csv(here('data/walk_data/vocab.csv')) 

vocab %>%
  pull(Word) %>%
  length() %>%
  cat('words in vocab')
```

## Recode Levels

```{r}
d.raw.oldlevels <- read_csv(here("data/exp1/raw.csv")) %>%
  mutate(correct = str_detect(wordpair, fixed(tolower(GUESS_1_FINAL))) 
                   & str_detect(wordpair, fixed(tolower(GUESS_2_FINAL)))) %>%
  rowwise() %>%
  mutate(Word1 = min(target1, target2),
         Word2 = max(target1, target2))

d.newlevels <- d.raw.oldlevels %>% 
  unite(wordpair, Word1, Word2, sep = '-') %>%
  group_by(wordpair) %>%
  summarize(correct = mean(correct)) %>%
  arrange(correct) %>%
  mutate(level = case_when(correct < .25 ~ 'Hard',
                           correct > .67 ~ 'Easy',
                           TRUE ~ 'Medium'))

# preserve ordering of target pair in d.raw
d.levels <- bind_rows(
  d.newlevels %>% group_by(wordpair, level) %>% tally(),
  d.newlevels %>% 
    separate(wordpair, into = c('word1', 'word2'), sep = '-') %>%
    unite(wordpair, word2, word1, sep = '-') %>% 
    group_by(wordpair, level) %>% tally()
) %>% select(-n)

d.raw <- d.raw.oldlevels %>%
  left_join(d.levels) %>%
  mutate(level = fct_relevel(level, 'Easy', 'Medium'))
```

## Exclusions

```{r}
inclusions <- d.raw %>%
  group_by(clueGiverID, wordpair) %>%
  tally() %>%
  group_by(clueGiverID) %>%
  tally() %>% 
  filter(n > 20) %>%
  pull(clueGiverID)

d <- read_csv(here("data/exp1/cleaned.csv")) %>%
  filter(clueGiverID %in% inclusions) %>%
  select(-Level) %>%
  left_join(d.newlevels %>% select(wordpair, level)) %>%
  left_join(d.raw %>% select(clueGiverID, Word1, Word2, correct) %>% unique())
```

## How many clues listed?

```{r}
d %>%
  group_by(clueGiverID, level, wordpair) %>%
  tally() %>%
  ggplot(aes(x = n - 1)) +
    geom_bar() +
    theme_few() +
    labs(x = 'clues generated') +
    facet_grid(~ level) +
    theme(aspect.ratio = 1)
```

## Individual differences? 

Most games stuck to exactly 3 clues but some were way out there.

```{r}
d %>%
  group_by(clueGiverID, level, wordpair) %>%
  tally() %>%
  group_by(clueGiverID) %>%
  mutate(avg_num_clues = mean(n)) %>%
  mutate(clueGiverID = as.character(clueGiverID)) %>%
  ggplot(aes(x = n - 1)) +
    geom_bar() +
    theme_few() +
    labs(x = 'clues generated') +
    facet_wrap(~ fct_reorder(clueGiverID, avg_num_clues)) +
    theme(aspect.ratio = 1/4)
```
# 2. Behavioral results

## 2.1 Manipulation check

```{r}
ggplot(d.newlevels, aes(x = correct*100, fill = level)) +
    geom_histogram(bins = 20) +
    geom_vline(xintercept = c(66, 25)) +
    labs(x = '% correct') +
    theme_few() +
    scale_fill_few()

ggsave(here('analysis/plots/difficulty_dist.pdf'), units = 'in', width = 7, height = 4)
```

```{r}
d.raw %>% group_by(level) %>% tidyboot_mean(correct, nboot = 1) 
```

```{r}
d.raw %>% group_by(level) %>% tidyboot_mean(TEOption1, nboot = 1000, na.rm = T) %>% 
  ggplot(aes(x = level, y = empirical_stat, fill = level)) +
    geom_bar(stat = 'identity') +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    labs(y = 'time to generate first clue (ms)') +
    theme_few() +
    scale_fill_few() +
    theme(aspect.ratio = 1, legend.position = 'none')

ggsave(here('analysis/plots/generation_time.pdf'), units = 'in', width = 4, height = 4)
```

```{r}
d.raw %>%
  lm(TEOption1 ~ level, data = .) %>%
  summary()
```

## 2.2: Order effects

```{r}
d.order <- d %>%
  filter(seqOrder %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueFinal')) %>%
  spread(seqOrder, correctedClue) %>%
  gather(seqOrder, correctedClue, starts_with('clueOption')) %>%
  mutate(match = clueFinal == correctedClue) %>%
  ungroup() %>%
  mutate(level = fct_relevel(level, 'Easy', 'Medium')) 

d.order %>%
  group_by(seqOrder, level) %>%
  summarize(m = mean(match, na.rm = T)) %>%
  spread(seqOrder, m) %>%
  mutate(other = 1 - clueOption1 - clueOption2 - clueOption3) %>%
  gather(seqOrder, m, -level) %>%
  ggplot(aes(x = level, y = m, fill = seqOrder)) +
    geom_bar(stat = 'identity') +
    theme_few() +
    scale_fill_colorblind(name = "order") +
    labs(y = 'proportion matching final clue', x = '') +
    theme(aspect.ratio = 1)

ggsave(here('analysis/plots/order.pdf'), units = 'in', width = 4, height = 3)
```

```{r}
d.order %>%
  group_by(seqOrder) %>%
  summarize(m = mean(match, na.rm = T))
```

```{r}
d.order %>%
  group_by(seqOrder, level) %>%
  summarize(m = mean(match, na.rm = T)) %>%
  spread(seqOrder, m) %>%
  mutate(other = 1 - clueOption1 - clueOption2 - clueOption3) %>% arrange(-clueOption1)
```

```{r}
library(lme4)
d.order %>%
  filter(seqOrder == 'clueOption1') %>%
  glmer(match ~ level + 
               (1 + level | clueGiverID) ,
        data = ., 
        family = 'binomial') %>%
  summary()
```

```{r}
d.order %>%
  glmer(match ~ seqOrder + 
               (1 + seqOrder | clueGiverID) ,
        data = ., 
        family = 'binomial',
        contrasts = list(seqOrder = contr.treatment(3, base = 2))) %>%
  summary()
```

## Associated with accuracy?

```{r}
d.order %>% 
  group_by(seqOrder, level, correct) %>%
  summarize(m = mean(match, na.rm = T)) %>%
  arrange(level, correct) %>%
  spread(seqOrder, m) %>%
  mutate(other = 1 - clueOption1 - clueOption2 - clueOption3) %>%
  gather(seqOrder, m, -level, -correct) %>%
  ggplot(aes(x = correct, y = m, fill = seqOrder)) +
    geom_bar(stat = 'identity', position = 'stack') +
    theme_few() +
    facet_grid(~ level) +
    scale_fill_colorblind(name = "order") +
    labs(y = 'proportion selected as clue', x = 'accuracy') +
    theme(aspect.ratio = 1) +
    ylim(0,1)
```

```{r}
d.order %>% 
  group_by(seqOrder, level, match) %>%
  tidyboot_mean(correct, na.rm = T) %>%
  filter(match) %>%
  arrange(level) %>%
  ggplot(aes(x = seqOrder, y = empirical_stat, color = level, group = level)) +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    theme_few() +
    scale_color_few(name = "order") +
    labs(y = 'accuracy', x = 'selection') +
    theme(aspect.ratio = 1) +
    ylim(0,1)
```

## Frequency differences?

Something weird is going on with Medium, but across the board, it looks like the final clue is less common than the ones in the list. 

```{r}
d %>% filter(seqOrder %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueFinal')) %>%
  left_join(vocab %>% rename(correctedClue = Word, freq= LgSUBTLWF), by = "correctedClue") %>%
  group_by(seqOrder, level) %>%
  tidyboot_mean(freq, na.rm = T) %>%
  ggplot(aes(x = seqOrder, y = empirical_stat, color = level, group = level)) +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0) +
    theme_few() +
    scale_fill_colorblind(name = "order") +
    labs(y = 'proportion matching final clue', x = 'difficulty') +
    theme(aspect.ratio = 1)
```

Statistics

```{r}
library(lmerTest)
d %>% filter(seqOrder %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueFinal')) %>%
  left_join(vocab %>% rename(correctedClue = Word, freq= LgSUBTLWF), by = "correctedClue") %>%
  lmer(freq ~ seqOrder + (1 | clueGiverID),
       data = .) %>%
  summary()
```

# 3. Model results

## Examine example walks

```{r}
pair = 'trauma-weird'

clues <- read_csv(here('data/exp1/cleaned.csv')) %>%
  filter(wordpair == pair) %>%
  group_by(correctedClue) %>%
  tally(name = 'clueCount') 

walks <- fromJSON(here(paste0('data/exp1/model_output/', pair, '-walks.json', collapse = ''))) %>% 
  as_tibble() %>%
  mutate(step = row_number()) %>%
  gather(walk, correctedClue, -step) %>%
  mutate(walk = gsub('walk-', '', walk),
         start = ifelse(as.integer(walk) %% 2 == 0, 'w1', 'w2')) 

left_join(clues, walks, by = c('correctedClue')) %>%
  group_by(walk, correctedClue) %>%
  select(-start) %>%
  filter(step == first(step)) %>%
  group_by(step, correctedClue) %>%
  tally() %>%
  ungroup() %>%
  complete(correctedClue, step = min(step):max(step), fill = list(n=0)) %>%
  group_by(correctedClue) %>%
  arrange(step, correctedClue) %>%
  mutate(cdf = cumsum(n)/2000) %>%
  ungroup() %>%
  left_join(clues) %>%
  ggplot(aes(x = step, y = cdf)) +
    geom_line(aes(group = correctedClue, alpha = clueCount)) +
    geom_text(aes(label = correctedClue), check_overlap = F,
              data = . %>% filter(clueCount > 4, step == 9990)) +
    #geom_line(color = 'red', data = . %>% group_by(step) %>% summarize(cdf = mean(cdf))) +
    theme_few() +
    scale_x_log10(limits = c(2,20000))


ggsave(here(paste0('analysis/plots/exp1-', pair, '-cdf.pdf')), units='in', height = 6, width = 6)
```

## Examine how far you have to go to find clue

```{r}
bind_rows(
  read_csv(here("data/exp1/model_output/ranks.csv"))  %>% mutate(src = 'empirical'),
  read_csv(here("data/exp1/model_output/ranks_permuted.csv")) %>% mutate(src = 'permuted')
) %>%
  left_join(read_csv(here("data/exp1/model_output/freq_scores.csv")) %>% mutate(src = 'empirical'), 
            by = c('clueGiverID', 'correctedClue', 'seqOrder', 'Level', 'src')) %>% 
  left_join(read_csv(here("data/exp1/model_output/midpoint_scores.csv")) %>% mutate(src = 'empirical'), 
            by = c('clueGiverID', 'correctedClue', 'seqOrder', 'Level', 'src')) %>%
  select(-Level) %>%
  left_join(d.levels) %>%
  mutate(seqOrder = fct_relevel(seqOrder, 'clueFinal', after = 3)) %>%
  group_by(src, wordpair, level, seqOrder,clueGiverID, correctedClue) %>%
  summarize(intersection = mean(intersection), 
            union = mean(union), 
            single = mean(c(w1_index_walk, w2_index_walk)),
            freq = mean(freq_index),
            mid = mean(mid_index)) %>% 
  filter(seqOrder %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueFinal')) %>%
  pivot_longer(names_to = 'measure', values_to = 'value', 
               cols = c(union, intersection, single, mid, freq)) %>% 
  ungroup() %>%
  mutate(level = fct_relevel(level, 'Easy', 'Medium', 'Hard')) %>%
  group_by(measure, seqOrder, src, level) %>%
  tidyboot_mean(value, nboot=10, na.rm = T) %>%
  ggplot(aes(x = seqOrder, y = empirical_stat, color = level, linetype = src, group = interaction(src, level))) +
    geom_line() +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.1, color = NA) +
    facet_grid( ~ measure) +
    scale_color_few() +
    scale_x_discrete(guide = guide_axis(angle = 90)) +
    theme_few() +
    scale_y_log10(limits=c(100,NA)) +
    labs(x = '', y = 'first occurrence') +
    theme(aspect.ratio = 2)

ggsave("../analysis/plots/exp1_ranks.pdf", width = 6, height = 4, units = 'in')
```

## Examine mixture scores

```{r}

read_csv(here("data/exp1/model_output/mixture_scores.csv")) %>% 
  mutate(src = 'empirical')%>%
  select(-Level) %>%
  left_join(d.levels) %>%
  mutate(seqOrder = fct_relevel(seqOrder, 'clueFinal', after = 3)) %>%
  group_by(src, wordpair, level, seqOrder,clueGiverID, correctedClue, alpha) %>%
  summarize(mix = mean(mixture_index)) %>% 
  filter(seqOrder %in% c('clueOption1', 'clueOption2', 'clueOption3', 'clueFinal')) %>%
  pivot_longer(names_to = 'measure', values_to = 'value', 
               cols = c(mix)) %>% 
  ungroup() %>%
  mutate(level = fct_relevel(level, 'Easy', 'Medium', 'Hard')) %>%
  group_by(measure, alpha, seqOrder, src, level) %>%
  tidyboot_mean(value, nboot=10, na.rm = T) %>%
  ggplot(aes(x = alpha, y = empirical_stat, color = level, linetype = src, group = interaction(src, level))) +
    geom_line() +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.1, color = NA) +
    facet_grid( ~ seqOrder) +
    scale_color_few() +
    #scale_x_discrete(guide = guide_axis(angle = 90)) +
    theme_few() +
    scale_y_log10(limits=c(100,NA)) +
    labs(x = 'alpha', y = 'first occurrence') +
    theme(aspect.ratio = 2)

ggsave("../analysis/plots/exp1_ranks_mixture.pdf", width = 6, height = 4, units = 'in')
```


## Examine walk scores

```{r}
d.scores <- bind_rows(
  read_csv(here("data/exp1/model_output/scores.csv")) %>% mutate(src = 'empirical'),
  read_csv(here("data/exp1/model_output/scores_permuted.csv")) %>% mutate(src = 'permuted')
) %>%
  filter(seqOrder %in% c('clueFinal', 'clueOption1', 'clueOption2', 'clueOption3')) %>%
  gather(budget, value, union_2:w2_8192) %>%
  separate(budget, into = c('strategy', 'budget')) %>% 
  filter(strategy != 'freq') %>%
  mutate(strategy = fct_collapse(strategy, single = c('w1', 'w2'))) %>%
  select(-Level) %>%
  left_join(d.levels) %>%
  mutate(level = fct_relevel(level, 'Easy', 'Medium', 'Hard')) %>%
  group_by(budget, src, level, strategy) %>%
  summarize(empirical_stat = mean(value, na.rm = T), 
            ci_upper = empirical_stat + 2 * sd(value, na.rm=T)/sqrt(length(value)),
            ci_lower = empirical_stat - 2 * sd(value, na.rm=T)/sqrt(length(value))
  ) 

d.scores %>%
  ggplot(aes(x = as.numeric(budget), y = empirical_stat, color = level, linetype = src, group = interaction(src, level))) +
    geom_line(size=1, position = 'dodge') +
    geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.1, color = NA) +
    facet_grid( ~ strategy, scales = 'free') +
    theme_few() +
    scale_color_few()+
    scale_x_log10() +
    labs(x = 'budget', y = 'P(visit)') +
    theme(aspect.ratio = 2)

ggsave("../analysis/plots/exp1_scores.pdf", width = 6, height = 4, units = 'in')
```



### MAY NOT NEED THESE EXTRA ANALYSES ###

# Examine lists of candidates

We compare the candidates generated by the models with the candidates generated by participants in a study.

```{r}
e1 = read_csv(here("data/exp1/e1_common_candidates.csv")) %>%
  mutate(Level = fct_relevel(Level, "easy", "medium","hard"))%>%
      mutate(budget = as.numeric(gsub("[^0-9.-]", "", budget)))
```

## overall common candidates

```{r}
common_candidates= e1 %>% rowwise()%>%
  mutate(prop_common_union = len_union_common/len_cluelist_behavioral,
    prop_common_intersection = len_intersection_common/len_cluelist_behavioral) %>%
  pivot_longer(names_to = "model", cols = prop_common_union:prop_common_intersection)%>%
  separate(model, into = c("prop", "index", "model")) %>% select(-c(prop,index))

e1plot = common_candidates %>% 
  group_by(Level, budget, model) %>%
  summarise(ci = list(mean_cl_boot(value) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% unnest%>%
ggplot(aes(x = budget, y = mean, color = model, group = model)) +
  geom_errorbar(aes(ymin=lwr, ymax=upr), size = 0.5, width=.2, 
                color = "gray", position = position_dodge(0))+
  geom_line()+
  geom_point(size = 2)+
  facet_wrap(~ Level)+
    labs(y = 'common candidates (proportion)', 
         title = "proportion of common candidates with behavioral data") +
  scale_color_calc()+
  theme_few() +
  theme(aspect.ratio = 1, legend.position = c(0.85, 0.2)) 

ggsave("../../analysis/plots/exp1_plot1.pdf", e1plot)

```

## final clue

```{r}
e1_finalclue = e1 %>% select(clueGiverID, Level, wordpair, clueFinal, 
                              budget, finalclue_index_union, finalclue_index_intersection) %>%
  pivot_longer(names_to = "model", cols = finalclue_index_union:finalclue_index_intersection) %>%
  separate(model, into = c("finalclue", "index", "model")) %>% select(-c(finalclue,index))%>%
  # set -1 to the lowest visitation frequency and take proportion for others
  # value == 1 means most visited node, value == 0 means not visited at all
  mutate(value = ifelse(value == -1, 0, (12218-value)/12218))

e1plot2 = e1_finalclue %>% 
  group_by(budget, model) %>%
  summarise(ci = list(mean_cl_boot(value) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% unnest%>%
  ggplot(aes(x = budget, y = mean, color = model, group = model)) +
  geom_errorbar(aes(ymin=lwr, ymax=upr), size = 0.5, width=.2, 
                color = "gray", position = position_dodge(0))+
  geom_line()+
  geom_point(size = 2)+
  labs(y = 'mean visitation proportion for final clue', 
       title = "proportion of final clue visitation") +
  theme_few() +
  scale_color_calc()+
  theme(aspect.ratio = 1, 
          legend.position = c(0.85, 0.2)) 
ggsave("../../analysis/plots/exp1_plot2.pdf", e1plot2)
```

