---
title: "Connector-RSA"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

# Imports

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(tidyboot)
library(here)
library(ggthemes)
library(geomtextpath)
```

Import word pairs and cleaned clue data from the connector paper.

```{r}
wordpairs <- read_csv(here("connector-cogsci2021/data/raw_data.csv")) %>%
  unite(wordpair, Word1, Word2, sep = '-') %>%
  select(wordpair, Level) %>%
  distinct()

c_clues = read_csv(here("connector-cogsci2021/data/final_board_clues_all.csv")) %>% 
  mutate(wordpair = gsub(' - ', '-', wordpair)) %>%
  distinct()
```


# Model comparison

Import the combined speaker predictions for all models (with/without RSA and on full vocabulary or on candidates).

```{r}

board_predictions_candidates <- 
  read_csv(here("search-models/data/finalexpdata_nonRSA_speaker.csv")) %>%
  left_join(c_clues %>% select(wordpair, Clue1, clueCount)) %>%
  mutate(alpha = as.factor(alpha))%>%
  rename(clue_score = score)%>%
  select(alpha, type, n_steps, wordpair, Clue1, clueCount, clue_score)

board_predictions_vocab <- read_csv(here("search-models/data/fullvocab_nonRSA_speaker.csv"))%>%
  left_join(c_clues %>% select(wordpair, Clue1, clueCount)) %>%
  mutate(alpha = as.factor(alpha), type = "full", n_steps = 5000) %>%
  select(alpha, type, n_steps, wordpair, Clue1, clueCount, clue_score)

rsa_predictions_vocab <- read_csv(here("search-models/data/fullvocab_RSA_speaker.csv"))%>%
  rename(clue_score = prag_speaker_probs) %>%
  mutate(alpha = "RSA", type = "full", n_steps = 5000)%>%
  select(alpha, type, n_steps, wordpair, Clue1, clueCount, clue_score)

rsa_predictions_candidates <- read_csv(here("search-models/data/finalexpdata_RSA_speaker.csv"))%>%
  left_join(c_clues %>% select(wordpair, Clue1, clueCount)) %>%
  select(alpha, type, n_steps, wordpair, Clue1, clueCount, clue_score)

speaker_compiled <- bind_rows(board_predictions_candidates, board_predictions_vocab,
                              rsa_predictions_vocab, rsa_predictions_candidates) %>%
  filter(!is.na(clue_score)) %>%
  left_join(wordpairs)
```

## Speaker Predictions

### Log likelihoods 

We look at log likelihoods as the most fundamental metric of model comparison

```{r}
sumLL = speaker_compiled %>% 
  mutate(ll = log(clue_score)) %>%
  group_by(alpha, type, n_steps) %>%
  summarize(ll = sum(ll * clueCount, na.rm = T))

sumLL %>%
  filter(n_steps < 50)%>%
  ggplot(aes(x = n_steps, y = ll, color = alpha, group = alpha)) +
  geom_point(size = 2)+
  geom_line()+
    labs(y = 'log likelihood') +
    facet_wrap(~type)+
    theme_few() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1),
         aspect.ratio = 1.5) 
```

## Online candidate study

We also compare the candidates generated by the models with the candidates generated by participants in a study.

```{r}
common = read_csv(here("search-models/data/common_candidates.csv")) %>%
  mutate(Level = fct_relevel(Level, "easy", "medium","hard")) %>%
  rowwise()%>%
  mutate(max_n = max(n_model_candidates, n_human_candidates),
    prop_common = n_intersection/max_n,
    candidate_type = gsub("[^0-9.-]", "",candidate_type )) 

common %>% 
  group_by(Level, candidate_type, type, n_steps) %>%
  summarise(ci = list(mean_cl_boot(prop_common) %>% 
                        rename(mean=y, lwr=ymin, upr=ymax))) %>% unnest%>%
  unite("type_n", type, n_steps, sep = "-") %>%
  mutate(type_n = factor(type_n))%>%
ggplot(aes(x = candidate_type, y = mean, color = type_n, group = type_n)) +
  geom_errorbar(aes(ymin=lwr, ymax=upr), size = 0.5, width=.2, 
                color = "gray", position = position_dodge(0))+
  geom_textline(aes(label = type_n), size =3, vjust = -0.5,
                linewidth = 0.3,linecolor  = "black",
                color = "deepskyblue4")+
  geom_point(size = 2)+
    labs(y = 'common candidates (proportion)') +
    facet_wrap(~Level)+
    theme_few() +
    theme(aspect.ratio = 1.5,
          legend.position = "none") 

```


